<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tone Player</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        :root {
            --primary: #4a9eff;
            --primary-hover: #3a8eef;
            --primary-dim: rgba(74, 158, 255, 0.1);
            --primary-dim2: rgba(74, 158, 255, 0.15);
            --bg: #1a1a1a;
            --bg-card: #222;
            --bg-input: #2a2a2a;
            --bg-hover: #333;
            --text: #eee;
            --text-dim: #999;
            --text-dimmer: #666;
            --border: #333;
            --danger: #ff4a4a;
            --success: #4aff7a;
            --favorite: #ff6b9d;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            background: var(--bg);
            color: var(--text);
            font-family: monospace;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* ── Player Section ── */
        .player-section {
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
            padding: 20px 24px 16px;
            flex-shrink: 0;
        }

        .player-top {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 12px;
        }

        .now-playing {
            flex: 1;
            min-width: 0;
        }

        .song-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .song-title.show { opacity: 1; }

        .song-artist {
            font-size: 13px;
            color: var(--text-dim);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-top: 2px;
        }

        .status-text {
            font-size: 12px;
            color: var(--text-dimmer);
            margin-top: 4px;
        }

        .progress-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }

        .progress-time {
            font-size: 11px;
            color: var(--text-dim);
            font-variant-numeric: tabular-nums;
            min-width: 36px;
        }

        .progress-track {
            flex: 1;
            height: 6px;
            background: var(--border);
            border-radius: 3px;
            overflow: hidden;
            cursor: pointer;
        }

        .progress-bar {
            height: 100%;
            background: var(--primary);
            width: 0%;
            transition: width 0.15s;
            border-radius: 3px;
        }

        /* ── Controls ── */
        .controls-row {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .ctrl-group {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .ctrl-group + .ctrl-group {
            margin-left: 8px;
        }

        .ctrl-btn {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text);
            width: 36px;
            height: 36px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.15s;
        }

        .ctrl-btn:hover { background: var(--bg-hover); border-color: var(--primary); }
        .ctrl-btn.active { background: var(--primary-dim); border-color: var(--primary); color: var(--primary); }
        .ctrl-btn.primary-btn { background: var(--primary); border-color: var(--primary); }
        .ctrl-btn.primary-btn:hover { background: var(--primary-hover); }

        .ctrl-label {
            font-size: 11px;
            color: var(--text-dim);
            margin-right: 4px;
        }

        .ctrl-select {
            background: var(--bg-input);
            border: 1px solid var(--border);
            color: var(--text);
            height: 36px;
            border-radius: 8px;
            padding: 0 8px;
            font-size: 12px;
            cursor: pointer;
        }

        .ctrl-select:hover { border-color: var(--primary); }

        .volume-slider {
            -webkit-appearance: none;
            appearance: none;
            width: 80px;
            height: 4px;
            border-radius: 2px;
            background: var(--border);
            outline: none;
            cursor: pointer;
        }

        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
        }

        .volume-slider::-moz-range-thumb {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
            border: none;
        }

        /* ── Toolbar ── */
        .toolbar {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 24px;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
            flex-wrap: wrap;
        }

        .search-box {
            flex: 1;
            min-width: 200px;
            position: relative;
        }

        .search-box i {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-dimmer);
            font-size: 14px;
        }

        .search-input {
            width: 100%;
            background: var(--bg-input);
            border: 1px solid var(--border);
            color: var(--text);
            padding: 8px 12px 8px 34px;
            border-radius: 8px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.15s;
        }

        .search-input:focus { border-color: var(--primary); }
        .search-input::placeholder { color: var(--text-dimmer); }

        .toolbar-select {
            background: var(--bg-input);
            border: 1px solid var(--border);
            color: var(--text);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 13px;
            cursor: pointer;
            outline: none;
        }

        .toolbar-select:hover, .toolbar-select:focus { border-color: var(--primary); }

        .toolbar-btn {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text);
            padding: 8px 14px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.15s;
            white-space: nowrap;
        }

        .toolbar-btn:hover { border-color: var(--primary); background: var(--primary-dim); }
        .toolbar-btn.active { border-color: var(--favorite); color: var(--favorite); background: rgba(255,107,157,0.1); }

        .tone-count {
            font-size: 12px;
            color: var(--text-dim);
            white-space: nowrap;
        }

        /* ── Tone List ── */
        .tone-list-container {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .tone-list {
            padding: 4px 12px;
        }

        .tone-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.1s;
            content-visibility: auto;
            contain-intrinsic-size: auto 44px;
        }

        .tone-item:hover { background: var(--bg-hover); }
        .tone-item.playing { background: var(--primary-dim2); }

        .tone-item-number {
            font-size: 12px;
            color: var(--text-dimmer);
            min-width: 36px;
            text-align: right;
            font-variant-numeric: tabular-nums;
        }

        .tone-item-info {
            flex: 1;
            min-width: 0;
        }

        .tone-item-name {
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .tone-item-artist {
            font-size: 12px;
            color: var(--text-dim);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .tone-item-fav {
            background: transparent;
            border: none;
            color: var(--text-dimmer);
            font-size: 16px;
            cursor: pointer;
            padding: 4px;
            transition: color 0.15s;
            flex-shrink: 0;
        }

        .tone-item-fav:hover { color: var(--favorite); }
        .tone-item-fav.is-fav { color: var(--favorite); }

        .tone-item-play {
            background: transparent;
            border: none;
            color: var(--text-dimmer);
            font-size: 16px;
            cursor: pointer;
            padding: 4px;
            flex-shrink: 0;
        }

        .tone-item-play:hover { color: var(--primary); }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-dim);
        }

        .empty-state i { font-size: 48px; display: block; margin-bottom: 16px; color: var(--text-dimmer); }
        .empty-state p { font-size: 14px; }

        /* ── Keyboard hint ── */
        .keyboard-hint {
            padding: 6px 24px 8px;
            font-size: 11px;
            color: var(--text-dimmer);
            background: var(--bg-card);
            border-top: 1px solid var(--border);
            flex-shrink: 0;
            text-align: center;
        }

        .keyboard-hint kbd {
            background: var(--bg-hover);
            border: 1px solid var(--border);
            border-radius: 3px;
            padding: 1px 5px;
            font-size: 10px;
            font-family: inherit;
        }

        /* ── Responsive ── */
        @media (max-width: 640px) {
            .player-section { padding: 14px 16px 12px; }
            .toolbar { padding: 10px 16px; }
            .tone-list { padding: 4px 8px; }
            .ctrl-group + .ctrl-group { margin-left: 4px; }
            .volume-slider { width: 60px; }
            .song-title { font-size: 17px; }
        }

        @media (prefers-reduced-motion: reduce) {
            * { transition: none !important; }
        }

        /* ── Scrollbar ── */
        .tone-list-container::-webkit-scrollbar { width: 8px; }
        .tone-list-container::-webkit-scrollbar-track { background: transparent; }
        .tone-list-container::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
        .tone-list-container::-webkit-scrollbar-thumb:hover { background: #555; }

        /* ── Loading ── */
        .loading-overlay {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            gap: 16px;
            color: var(--text-dim);
        }

        @keyframes spin { to { transform: rotate(360deg); } }
        .spinner { animation: spin 1s linear infinite; font-size: 32px; color: var(--primary); }
    </style>
</head>
<body>

    <!-- Player Section -->
    <div class="player-section">
        <div class="player-top">
            <div class="now-playing">
                <div class="song-title" id="songTitle">
                    <i class="bi bi-music-note-beamed"></i> Loading tones...
                </div>
                <div class="song-artist" id="songArtist">Please wait</div>
                <div class="status-text" id="statusText">
                    <i class="bi bi-hourglass-split"></i> Initializing...
                </div>
            </div>
        </div>

        <div class="progress-row">
            <span class="progress-time" id="timeElapsed">0:00</span>
            <div class="progress-track" id="progressTrack">
                <div class="progress-bar" id="progressBar"></div>
            </div>
            <span class="progress-time" id="timeTotal">0:00</span>
        </div>

        <div class="controls-row">
            <div class="ctrl-group">
                <button class="ctrl-btn" id="btnPrev" title="Previous (P)"><i class="bi bi-skip-backward-fill"></i></button>
                <button class="ctrl-btn primary-btn" id="btnStop" title="Stop (S)"><i class="bi bi-stop-fill"></i></button>
                <button class="ctrl-btn" id="btnNext" title="Next (N)"><i class="bi bi-skip-forward-fill"></i></button>
                <button class="ctrl-btn" id="btnRandom" title="Random (R)"><i class="bi bi-shuffle"></i></button>
            </div>

            <div class="ctrl-group">
                <button class="ctrl-btn" id="btnAutoPlay" title="Auto-play next"><i class="bi bi-arrow-repeat"></i></button>
            </div>

            <div class="ctrl-group">
                <span class="ctrl-label"><i class="bi bi-volume-up"></i></span>
                <input type="range" class="volume-slider" id="volumeSlider" min="0" max="100" value="70">
            </div>

            <div class="ctrl-group">
                <span class="ctrl-label">Speed</span>
                <select class="ctrl-select" id="speedSelect">
                    <option value="0.5">0.5x</option>
                    <option value="0.75">0.75x</option>
                    <option value="1" selected>1x</option>
                    <option value="1.25">1.25x</option>
                    <option value="1.5">1.5x</option>
                    <option value="2">2x</option>
                </select>
            </div>

            <div class="ctrl-group">
                <span class="ctrl-label">Wave</span>
                <select class="ctrl-select" id="waveSelect">
                    <option value="square" selected>Square</option>
                    <option value="sine">Sine</option>
                    <option value="triangle">Triangle</option>
                    <option value="sawtooth">Sawtooth</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Toolbar -->
    <div class="toolbar">
        <div class="search-box">
            <i class="bi bi-search"></i>
            <input type="text" class="search-input" id="searchInput" placeholder="Search tones by name or artist...">
        </div>

        <select class="toolbar-select" id="sortSelect">
            <option value="name-asc">Name A-Z</option>
            <option value="name-desc">Name Z-A</option>
            <option value="artist-asc">Artist A-Z</option>
            <option value="artist-desc">Artist Z-A</option>
        </select>

        <select class="toolbar-select" id="artistFilter">
            <option value="">All Artists</option>
        </select>

        <button class="toolbar-btn" id="btnFavFilter">
            <i class="bi bi-heart"></i> Favorites
        </button>

        <span class="tone-count" id="toneCount"></span>
    </div>

    <!-- Tone List -->
    <div class="tone-list-container" id="toneListContainer">
        <div class="loading-overlay" id="loadingOverlay">
            <i class="bi bi-music-note-list spinner"></i>
            <p>Loading tone library...</p>
        </div>
        <div class="tone-list" id="toneList"></div>
    </div>

    <!-- Footer -->
    <div class="keyboard-hint">
        <kbd>Space</kbd> Stop &nbsp;
        <kbd>R</kbd> Random &nbsp;
        <kbd>N</kbd> Next &nbsp;
        <kbd>P</kbd> Previous &nbsp;
        <kbd>/</kbd> Search
    </div>

    <script>
        // ── State ──
        let audioContext;
        let timeouts = [];
        let activeOscillators = [];
        let tonesList = [];
        let filteredTones = [];
        let currentTone = '';
        let currentToneIndex = -1;
        let currentToneMeta = null;
        let isPlaying = false;
        let playbackStartTime = 0;
        let totalDuration = 0;
        let progressInterval = null;

        // Preferences (loaded from localStorage)
        let prefs = {
            volume: 0.7,
            speed: 1,
            waveform: 'square',
            autoPlay: true,
            sortBy: 'name-asc',
            favorites: [],
            showFavoritesOnly: false
        };

        // ── Frequency Table ──
        const freq = {
            'c': 261.63, 'c#': 279.07, 'db': 279.07,
            'd': 293.66, 'd#': 311.13, 'eb': 311.13,
            'e': 329.63,
            'f': 349.23, 'f#': 369.99, 'gb': 369.99,
            'g': 392.00, 'g#': 415.30, 'ab': 415.30,
            'a': 440.00, 'a#': 466.16, 'bb': 466.16,
            'b': 493.88
        };

        // ── Fallback Tones ──
        const fallbackTones = [
            { "name": "Jay - Z Feat. Linkin Park - Numb Encore", "file": "Jay - Z Feat. Linkin Park - Numb Encore.txt", "content": "ZFeat.Li:d=4,o=5,b=100:a#,8p,8a#,a#,g#,a#,8a#,8a#,a#,c6,g#,8a#,8a#,a#,g#,a#,8a#,8a#,a#,g#,a#,8p,8a#,a#,g#,a#,8a#,8a#,a#,c6,g#,8a#,8a#,a#,g#,a#,8a#,8a#,a#,g#,a#,8p,8a#,a#,g#,a#,8a#,8a#,a#,c6,g#,8a#,8a#,a#,g#,a#,8a#,8a#,a#,g#,a#" },
            { "name": "Jay Z feat. Linkin Park - Numb Encore", "file": "Jay Z feat. Linkin Park - Numb Encore.txt", "content": "NumbEnco:d=4,o=6,b=100:a_5,8p,8a_5,a_5,g_5,a_5,8a_5,8a_5,a_5,c,g_5,8a_5,8a_5,a_5,g_5,a_5,8a_5,8a_5,a_5,g_5,a_5,8p,8a_5,a_5,g_5,a_5,8a_5,8a_5,a_5,c,g_5,8a_5,8a_5,a_5,g_5,a_5,8a_5,8a_5,a_5,g_5,a_5,8p,8a_5,a_5,g_5,a_5,8a_5,8a_5,a_5,c,g_5,8a_5,8a_5,a_5,g_5,a_5,8a_5,8a_5,a_5,g_5,a_5" },
            { "name": "Linkin Park - 1 Step Closer", "file": "Linkin Park - 1 Step Closer.txt", "content": "1StepClo:d=4,o=6,b=112:32p,16a5,16a5,8a5,8a5,8g,8f_5,8g5,f_5,8a5,16a5,16a5,8a5,8g5,8f_5,8d,c,32p,16a5,16a5,8a5,8a5,8g,8f_5,8g5,f_5,8a5,16a5,16a5,8a5,8g5,8f_5,8d,c" },
            { "name": "Linkin Park - One Step Closer", "file": "Linkin Park - One Step Closer.txt", "content": "OneStepC:d=8,o=5,b=63:32p,16a,16a,a,a,g,f#,g,4f#.,a,16a,16a,a,g,f#,d6,4c.6" },
            { "name": "Linkin Park - One Step Closer 1", "file": "Linkin Park - One Step Closer 1.txt", "content": "OneStepC:d=4,o=5,b=100:8c#,8c#6,16g#,8d#.6,8a,8g#,16c#,8e.,8c#,8c#6,16g#,8d#.6,8a,8g#,16c#,8e.,8c#,8c#6,16g#,8d#.6,8a,8g#,16c#,8e.,8c#,8c#6,16g#,8d#.6,8a,8g#,16c#,8e." },
            { "name": "Linkin Park - One Step Closer 2", "file": "Linkin Park - One Step Closer 2.txt", "content": "OneStepC:d=4,o=5,b=100:16g#,16g#,8g#,8g#,8g#,8f#,8f#,16b,16b,8c#6,8c#6,16c#6,16c#6,16c#6,16c#6,8c#6,8p,16c#6,16c#6,16c#6,16c#6,8c#6,8p,16g#,16g#,8g#,8g#,8g#,8f#,8f#,16b,16b,8c#6,8c#6,16c#6,16c#6,16c#6,16c#6,8c#6,8p,16c#6,16c#6,16c#6,16c#6,8c#6" },
            { "name": "Linkin Park - Breaking The Habit", "file": "Linkin Park - Breaking The Habit.txt", "content": "Breaking:d=4,o=6,b=180:e5,8c,8c,8p,8b5,8p,8a5,8p,g5,8a5,8p,8a5,p,8p,8e5,8c,8c,8p,8b5,8p,8a5,8p,b.5,2p,8p,8e5,8c,8c,8p,8b5,8p,8a5,8p,g5,8a5,8p,8a5,p,8p,8e5,8c,8c,8p,8b5,8p,8a5,8p,8b5,2p,p,8p,8e5,8c,8c,8p,8b5,8p,8a5,8p,g.5,a5,a5,8p,8e5,8c,8c,8p,8b5,8p,8a5,8p,8b5,2p,e5,e5,1c,2b5,2a5,2c.,b5,2b.5,e5,1c,2b5,2a5,2c.,b5,2b.5,8a5,a.5" },
            { "name": "Linkin Park - By Myself", "file": "Linkin Park - By Myself.txt", "content": "ByMyself:d=4,o=6,b=220:c.5,8c,8d_5,d_.5,8c5,f5,c5,g_5,2d5,d5,c.5,8c,8d_5,d_.5,8c5,f5,c5,g_5,2d5,d5,c.5,8c,8d_5,d_.5,8c5,f5,c5,g_5,2d5,d5,d_.5,8c5,f5,c5,f5,c5,g_5,2d5,d5,c.5,8c,8d_5,d_.5,8c5,f5,c5,g_5,2d5,d5" },
            { "name": "Linkin Park - Crawling (Intro)", "file": "Linkin Park - Crawling (Intro).txt", "content": "Crawling:d=4,o=6,b=112:8e5,c.,b.5,p,a5,8g5,f#5,g5,8e5,c.,b.5,p,a5,8g5,f#5,g5,8e5,c.,b.5,p,a5,8g5,f#5,g5" },
            { "name": "Linkin Park - Crawling", "file": "Linkin Park - Crawling.txt", "content": "Crawling:d=16,o=5,b=125:2b,2g#,4f#,8e,4d#,4e,8c#,2b,2g#,4f#,8e,4d#,4e,8c#,4g#.,8a,4g#.,8a,1g#,4g#.,8a,4g#.,8a,8g#,2f#." },
            { "name": "Linkin Park - Crawlin", "file": "Linkin Park - Crawlin.txt", "content": "Crawlin:d=4,o=6,b=40:16a.5,32a_5,16a.5,32a_5,8a.5,32p,32a_5,16a.5,32a_5,16a.5,32a_5,32a5,8g.5,32p,16a.5,32a_5,16a.5,32a_5,8a.5,32p,32a_5,16a.5,32a_5,16a.5,32a_5,32a5,g5" },
            { "name": "Linkin Park - Crawling 1", "file": "Linkin Park - Crawling 1.txt", "content": "Crawling:d=32,o=5,b=25:p,16a.,a#,16a.,a#,8a.,a,16a.,a#,16a.,a#,a,8g.,16a.,a#,16a.,a#,8a.,a,16a.,a#,16a.,a#,a,4g" },
            { "name": "Linkin Park - Crawling 2", "file": "Linkin Park - Crawling 2.txt", "content": "Crawling:d=4,o=5,b=40:32p,16d,8c.6,a,16g.,32f.,16e.,16f.,16d,8c.6,a,16g.,32f.,16e.,16f." },
            { "name": "Linkin Park - Faint", "file": "Linkin Park - Faint.txt", "content": "Faint:d=4,o=5,b=140:g6,16c,16p,g6,16c,16p,g6,16d#,16p,8g6,8g6,8f6,8g6,8g6,g6,16g#,16p,8g6,8g6,8f6,8g6,8g6,g6,8g6,8g6,16f,16p,8g6,16g,16p,8f6,g6,g6,16c,16p,g6,16c,16p,g6,16d#,16p,8g6,8g6,8f6,8g6,8g6,g6,16g#,16p,8g6,8g6,8f6,8g6,8g6,g6,8g6,8g6,16f,16p,8g6,16g,16p,8f6,g6,8c" },
            { "name": "Linkin Park - In The End (Introduction)", "file": "Linkin Park - In The End (Introduction).txt", "content": "InTheEnd:d=4,o=6,b=200:d.5,32p,a.5,32p,a.5,32p,f.5,32p,e.5,32p,e.5,32p,e.5,32p,e.5,32p,8e.5,8f.5,d.5,32p,a.5,32p,a.5,32p,f.5,32p,e.5,32p,e.5,32p,e.5,32p,8e.5,8f.5,d.5,32p,a.5,32p,a.5,32p,f.5,32p,e.5,32p,e.5,32p,e.5,32p,8e.5,8f.5,d.5" },
            { "name": "Linkin Park - In The End", "file": "Linkin Park - In The End.txt", "content": "InTheEnd:d=16,o=5,b=180:4d.,8p,4a.,8p,4a.,8p,4f.,8p,4e.,8p,4e.,8p,4e.,8p,4e,4f,4d.,8p,4a.,8p,4a.,8p,4f.,8p,4e.,8p,4e.,8p,4e.,8p,4e,4f,4d.,8p,4a.,8p,4a.,8p,4f.,8p,4e.,8p,4e.,8p,4e.,8p,4e,4f,4d." },
            { "name": "Linkin Park - In The End 1", "file": "Linkin Park - In The End 1.txt", "content": "InTheEnd:d=4,o=6,b=180:d.5,8p,a.5,8p,a.5,8p,f.5,8p,e.5,8p,e.5,8p,e.5,8p,e5,f5,d.5,8p,a.5,8p,a.5,8p,f.5,8p,e.5,8p,e.5,8p,e.5,8p,e5,f5,d.5,8p,a.5,8p,a.5,8p,f.5,8p,e.5,8p,e.5,8p,e.5,8p,e5,f5,d.5" },
            { "name": "Linkin Park - In The End 2", "file": "Linkin Park - In The End 2.txt", "content": "InTheEnd:d=8,o=5,b=80:e.,b.,b.,g.,f#.,f#.,f#.,16.f#.,16.g.,e.,b.,b.,g.,f#.,f#.,f#.,16.f#.,16.g.,e.,b.,b.,g.,f#.,f#.,f#.,16.f#.,16.g.,e.,b.,b.,g.,f#.,f#.,f#.,16.f#.,16.g." },
            { "name": "Linkin Park - In The End 3", "file": "Linkin Park - In The End 3.txt", "content": "InTheEnd:d=8,o=6,b=112:4c#,4d#,4f.,f,f.,c#.,2c#,4p,16c#,c#,d#,4f.,f,16f,16d#,f,f#,f,4d#,p,a#5,4c#,4d#,4f.,f,f.,c#.,2c#,4p,16c#,c#,d#,4f.,f,16f,16d#,f,d#,4f#,f,d#,4c#." },
            { "name": "Linkin Park - My December", "file": "Linkin Park - My December.txt", "content": "MyDecemb:d=16,o=5,b=112:8c6,8c6,4c6,4a,1g,8p,8c6,8c6,4c6,4a,4g,4d6,4c6,2g,8p,8c6,8c6,4c6,4a,1g,8p,8c6,8c6,4c6,4a,4g,4d6,4c6,4g" },
            { "name": "Linkin Park - Numb", "file": "Linkin Park - Numb.txt", "content": "Numb:d=4,o=6,b=112:f_.,8f_,f_,e,f_,8f_,8f_,f_,g_,e.,8f_,f_,e,f_,8f_,8f_,f_,e,f_.,8f_,f_,e,f_,8f_,8f_,f_,g_,e.,8f_,f_,e,f_,8f_,8f_,f_,e,p,8f_,8f_,8f_,8f_,8e,f_,8e" },
            { "name": "Linkin Park - Numb V2", "file": "Linkin Park - Numb V2.txt", "content": "NumbV2:d=4,o=6,b=112:8c,8e,8c_,f_.,a.,g_.,p,8c_,8e,8c_,a.,g_.,2e,8p,8c_,8e,8c_,f_.,a.,g_.,p,8c_,8e,8c_,a.,g_.,2e" },
            { "name": "Linkin Park - Paper Cut", "file": "Linkin Park - Paper Cut.txt", "content": "PaperCut:d=16,o=5,b=140:8c#7,8g#6,8d#7,8g#6,8e7,8g#6,8d#7,8g#6,8c#7,8g#6,8d#7,8g#6,8e7,8g#6,8d#7,8g#6,8c#,8c#,8c#,4e6,4d#6,1b,8c#,8c#,8c#,4e6,4d#6,1b" },
            { "name": "Linkin Park - Papercut", "file": "Linkin Park - Papercut.txt", "content": "Papercut:d=4,o=5,b=140:8c#7,8g#6,8d#7,8g#6,8e7,8g#6,8d#7,8g#6,8c#7,8g#6,8d#7,8g#6,8e7,8g#6,8d#7,8g#6,8c#,8c#,8c#,e6,d#6,1b,8c#,8c#,8c#,e6,d#6,1b" },
            { "name": "Linkin Park - Points Of Authority", "file": "Linkin Park - Points Of Authority.txt", "content": "PointsOf:d=16,o=5,b=200:4e7,4e7,8d7,4d7,4c7,4c7,4c6,1e7,4e7,4e7,8d7,4d7,4c7,4c7,4c6,1e7,4e7,4e7,8d7,4d7,4c7,4c7,4c6,1e7,4e7,4e7,8d7,4d7,4c7,4c7,4c6,2e7,2e6,4c7,8c7,4c7,4c7,4c7" },
            { "name": "Linkin Park - Somewhere I Belong", "file": "Linkin Park - Somewhere I Belong.txt", "content": "Somewher:d=4,o=5,b=160:8g6,8g6,8f6,g6,8c,8p,8c,8g6,8g6,8f6,g6,8d#,8p,8d#,8p,8g6,8f6,g6,8f6,8g6,8g#,8g#6,8g#,g.6,8f,8p,8f,8g6,8g6,8f6,g6,8g6,8f6,8c,8d#6,8c,8f6,8d#,8d#6,8d#,8f6,8d#,8g6,8d#,2g6,8p,8g#,8p,8g#,8p,8f,8p,8f,8p,8f,8c" },
            { "name": "Linkin Park - Somewhere I Belong V2", "file": "Linkin Park - Somewhere I Belong V2.txt", "content": "Somewher:d=4,o=5,b=160:8c7,8c7,8a#6,c7,8f,8p,8f,8c7,8c7,8a#6,c7,8g#,8p,8g#,8p,8c7,8a#6,c7,8a#6,8c7,8c#6,8c#7,8c#6,c.7,8a#,8p,8a#,8c7,8c7,8a#6,c7,8c7,8a#6,8f,8g#6,8f,8a#6,8g#,8g#6,8g#,8a#6,8g#,8c7,8g#,2c7,8p,8c#6,8p,8c#6,8p,8a#,8p,8a#,8p,8a#,8f" },
            { "name": "Linkin Park - With You", "file": "Linkin Park - With You.txt", "content": "WithYou:d=4,o=6,b=160:f5,c5,g_5,2d5,d5,c.5,8c,8d_5,d_.5,8c5,f5,c5,g_5,2d5,d5,f5,8d_5,d_.5,8c5,f5,c5,g_5,2d5,d5,2d5,d5,c.5,8c,8d_5,d_.5,8c5,f5,8d_5,d_.5,8c5,f5,8d_5,d_.5,8c5,d_.5,8c5,f5,c5,g_5,2d5,d5,f5,8d_5,d_.5,8c5,f5,c5,g_5,2d5,d5,2d5,d5,c.5,8c,c5,g_5,2d5,d5,2d5,d5,c.5,8c,8d_5,d_.5" },
            { "name": "Linkin park - A Place For My Head", "file": "Linkin park - A Place For My Head.txt", "content": "APlaceFo:d=16,o=5,b=125:4a,8a,e6,e6,8e6,8f6,8e6,8d6,4c6,8c6,a,a,8a#,8a#,8a#,8c6,4a,8a,e6,e6,8e6,8f6,8e6,8d6,4c6,8c6,a,a,8a#,8a#,8a#,8c6" },
            { "name": "Linkin Park - Place 4 My Head", "file": "Linkin Park - Place 4 My Head.txt", "content": "Place4My:d=4,o=6,b=140:a5,8a5,16e,16e,8e,8f,8e,8d,8p,c,16a5,16a5,8a_5,8a_5,8c,a5,8a5,16e,16e,8e,8f,8e,8d,8p,c,16a5,16a5,8a_5,8a_5,8a_5,8c,a5" }
        ];

        // ── DOM References ──
        const dom = {
            songTitle: document.getElementById('songTitle'),
            songArtist: document.getElementById('songArtist'),
            statusText: document.getElementById('statusText'),
            progressBar: document.getElementById('progressBar'),
            progressTrack: document.getElementById('progressTrack'),
            timeElapsed: document.getElementById('timeElapsed'),
            timeTotal: document.getElementById('timeTotal'),
            toneList: document.getElementById('toneList'),
            toneListContainer: document.getElementById('toneListContainer'),
            loadingOverlay: document.getElementById('loadingOverlay'),
            searchInput: document.getElementById('searchInput'),
            sortSelect: document.getElementById('sortSelect'),
            artistFilter: document.getElementById('artistFilter'),
            toneCount: document.getElementById('toneCount'),
            volumeSlider: document.getElementById('volumeSlider'),
            speedSelect: document.getElementById('speedSelect'),
            waveSelect: document.getElementById('waveSelect'),
            btnStop: document.getElementById('btnStop'),
            btnPrev: document.getElementById('btnPrev'),
            btnNext: document.getElementById('btnNext'),
            btnRandom: document.getElementById('btnRandom'),
            btnAutoPlay: document.getElementById('btnAutoPlay'),
            btnFavFilter: document.getElementById('btnFavFilter')
        };

        // ── Preferences ──
        function loadPrefs() {
            try {
                const saved = localStorage.getItem('tonePlayerPrefs');
                if (saved) {
                    const parsed = JSON.parse(saved);
                    Object.assign(prefs, parsed);
                }
            } catch {}
            // Apply to UI
            dom.volumeSlider.value = prefs.volume * 100;
            dom.speedSelect.value = prefs.speed;
            dom.waveSelect.value = prefs.waveform;
            dom.sortSelect.value = prefs.sortBy;
            if (prefs.autoPlay) dom.btnAutoPlay.classList.add('active');
            if (prefs.showFavoritesOnly) dom.btnFavFilter.classList.add('active');
        }

        function savePrefs() {
            try {
                localStorage.setItem('tonePlayerPrefs', JSON.stringify(prefs));
            } catch {}
        }

        // ── Parse Artist/Title from tone name ──
        function parseToneName(name) {
            const dashIdx = name.indexOf(' - ');
            if (dashIdx > 0) {
                return {
                    artist: name.substring(0, dashIdx).trim(),
                    title: name.substring(dashIdx + 3).trim()
                };
            }
            return { artist: 'Unknown', title: name };
        }

        // ── Artist extraction and filter population ──
        function populateArtistFilter() {
            const artists = new Map();
            tonesList.forEach(t => {
                const { artist } = parseToneName(t.name);
                const key = artist.toLowerCase();
                if (!artists.has(key)) {
                    artists.set(key, { name: artist, count: 0 });
                }
                artists.get(key).count++;
            });

            const sorted = [...artists.values()].sort((a, b) => a.name.localeCompare(b.name));
            dom.artistFilter.innerHTML = '<option value="">All Artists</option>';
            sorted.forEach(a => {
                const opt = document.createElement('option');
                opt.value = a.name;
                opt.textContent = `${a.name} (${a.count})`;
                dom.artistFilter.appendChild(opt);
            });
        }

        // ── Filtering and Sorting ──
        function applyFiltersAndSort() {
            const query = dom.searchInput.value.toLowerCase().trim();
            const artistVal = dom.artistFilter.value;
            const sort = dom.sortSelect.value;

            filteredTones = tonesList.filter(t => {
                // Search filter
                if (query && !t.name.toLowerCase().includes(query)) return false;
                // Artist filter
                if (artistVal) {
                    const { artist } = parseToneName(t.name);
                    if (artist !== artistVal) return false;
                }
                // Favorites filter
                if (prefs.showFavoritesOnly) {
                    if (!prefs.favorites.includes(t.name)) return false;
                }
                return true;
            });

            // Sort
            const [sortField, sortDir] = sort.split('-');
            filteredTones.sort((a, b) => {
                let va, vb;
                if (sortField === 'artist') {
                    va = parseToneName(a.name).artist.toLowerCase();
                    vb = parseToneName(b.name).artist.toLowerCase();
                } else {
                    va = a.name.toLowerCase();
                    vb = b.name.toLowerCase();
                }
                const cmp = va.localeCompare(vb);
                return sortDir === 'desc' ? -cmp : cmp;
            });

            renderToneList();
            updateToneCount();
        }

        // ── Render Tone List ──
        function renderToneList() {
            const fragment = document.createDocumentFragment();

            if (filteredTones.length === 0) {
                const empty = document.createElement('div');
                empty.className = 'empty-state';
                empty.innerHTML = `
                    <i class="bi bi-music-note-list"></i>
                    <p>${tonesList.length === 0 ? 'Loading tones...' : 'No tones match your filters'}</p>
                `;
                fragment.appendChild(empty);
            } else {
                filteredTones.forEach((tone, idx) => {
                    const { artist, title } = parseToneName(tone.name);
                    const isFav = prefs.favorites.includes(tone.name);
                    const isCurrent = currentToneMeta && tone.name === currentToneMeta.name;

                    const item = document.createElement('div');
                    item.className = 'tone-item' + (isCurrent ? ' playing' : '');
                    item.dataset.idx = idx;

                    item.innerHTML = `
                        <span class="tone-item-number">${idx + 1}</span>
                        <div class="tone-item-info">
                            <div class="tone-item-name">${escapeHtml(title)}</div>
                            <div class="tone-item-artist">${escapeHtml(artist)}</div>
                        </div>
                        <button class="tone-item-fav ${isFav ? 'is-fav' : ''}" data-name="${escapeAttr(tone.name)}" title="Toggle favorite">
                            <i class="bi bi-heart${isFav ? '-fill' : ''}"></i>
                        </button>
                        <button class="tone-item-play" title="Play">
                            <i class="bi bi-play-fill"></i>
                        </button>
                    `;

                    fragment.appendChild(item);
                });
            }

            dom.toneList.innerHTML = '';
            dom.toneList.appendChild(fragment);
        }

        function updateToneCount() {
            const total = tonesList.length;
            const shown = filteredTones.length;
            dom.toneCount.textContent = shown === total
                ? `${total.toLocaleString()} tones`
                : `${shown.toLocaleString()} of ${total.toLocaleString()} tones`;
        }

        function escapeHtml(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        function escapeAttr(str) {
            return str.replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/'/g, '&#39;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        }

        // ── Format time ──
        function formatTime(seconds) {
            const m = Math.floor(seconds / 60);
            const s = Math.floor(seconds % 60);
            return `${m}:${s.toString().padStart(2, '0')}`;
        }

        // ── Audio Engine ──
        function getFreqHz(note, octave) {
            if (!note) return 0;
            note = note.toLowerCase();
            const base = freq[note];
            if (!base) return 0;
            octave = Math.max(0, Math.min(10, octave));
            return base * Math.pow(2, octave - 5);
        }

        function playNote(frequency, duration) {
            if (!frequency || !audioContext) return;
            try {
                const osc = audioContext.createOscillator();
                const gain = audioContext.createGain();
                osc.connect(gain);
                gain.connect(audioContext.destination);

                osc.frequency.value = Math.max(20, Math.min(20000, frequency));
                osc.type = prefs.waveform;

                const vol = prefs.volume;
                const now = audioContext.currentTime;
                gain.gain.setValueAtTime(0, now);
                gain.gain.linearRampToValueAtTime(vol, now + 0.0003);
                gain.gain.linearRampToValueAtTime(vol, now + duration - 0.003);
                gain.gain.linearRampToValueAtTime(0, now + duration);

                osc.start(now);
                osc.stop(now + duration);
                activeOscillators.push(osc);

                osc.onended = () => {
                    const idx = activeOscillators.indexOf(osc);
                    if (idx > -1) activeOscillators.splice(idx, 1);
                    try { osc.disconnect(); gain.disconnect(); } catch {}
                };
            } catch (error) {
                console.warn('Error playing note:', error);
            }
        }

        function parseRTTTL(rtttl) {
            try {
                const parts = rtttl.split(':');
                if (parts.length < 3) throw new Error('Invalid RTTTL format');

                const defaults = parts[1];
                const notes = parts.slice(2).join(':');

                let bpm = 120, defDur = 4, defOct = 5;

                defaults.split(',').forEach(p => {
                    const trimmed = p.trim();
                    if (trimmed.includes('=')) {
                        const [k, v] = trimmed.split('=');
                        const key = k.trim().toLowerCase();
                        const value = parseInt(v.trim());
                        if (!isNaN(value)) {
                            if (key === 'b') bpm = Math.max(1, value);
                            if (key === 'd') defDur = Math.max(1, value);
                            if (key === 'o') defOct = Math.max(0, Math.min(10, value));
                        }
                    }
                });

                const result = [];
                notes.split(',').forEach(token => {
                    token = token.trim();
                    if (!token) return;

                    let dur = defDur, oct = defOct, note = '';
                    let rem = token;

                    const durMatch = rem.match(/^(\d+)/);
                    if (durMatch) {
                        dur = parseInt(durMatch[1]);
                        rem = rem.slice(durMatch[1].length);
                    }

                    const noteMatch = rem.match(/^([a-gpr][#_]?b?)/i);
                    if (noteMatch) {
                        note = noteMatch[1].toLowerCase().replace('_', '#');
                        rem = rem.slice(noteMatch[1].length);
                        if (note === 'r') note = 'p';
                    }

                    const octMatch = rem.match(/^(\d+)/);
                    if (octMatch) {
                        oct = parseInt(octMatch[1]);
                        rem = rem.slice(octMatch[1].length);
                    }

                    const dots = (rem.match(/\./g) || []).length;

                    // Apply speed multiplier
                    let duration = (60 / bpm) * (4 / dur) / prefs.speed;
                    for (let i = 0; i < dots; i++) duration *= 1.5;

                    const frequency = (note === 'p') ? 0 : getFreqHz(note, oct);
                    result.push({ frequency, duration, note, octave: oct });
                });

                return result;
            } catch (error) {
                console.error('Error parsing RTTTL:', error);
                return [];
            }
        }

        // ── Playback ──
        async function playTone(toneString) {
            if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
            await audioContext.resume();

            stopTone(true);

            const notes = parseRTTTL(toneString);
            if (notes.length === 0) {
                setStatus('bi-exclamation-triangle-fill', 'Invalid tone format');
                return;
            }

            isPlaying = true;
            const noteSeparation = 0.015;
            totalDuration = notes.reduce((s, n) => s + n.duration + noteSeparation, 0);
            dom.timeTotal.textContent = formatTime(totalDuration);
            playbackStartTime = Date.now();

            // Start progress updater
            progressInterval = setInterval(() => {
                if (!isPlaying) return;
                const elapsed = (Date.now() - playbackStartTime) / 1000;
                const pct = Math.min((elapsed / totalDuration) * 100, 100);
                dom.progressBar.style.width = pct + '%';
                dom.timeElapsed.textContent = formatTime(Math.min(elapsed, totalDuration));
            }, 100);

            let time = 0;
            notes.forEach((note, i) => {
                const t = setTimeout(() => {
                    if (note.frequency > 0) playNote(note.frequency, note.duration);

                    if (i === notes.length - 1) {
                        const finishTimeout = setTimeout(() => {
                            isPlaying = false;
                            clearInterval(progressInterval);
                            dom.progressBar.style.width = '100%';
                            dom.timeElapsed.textContent = formatTime(totalDuration);
                            setStatus('bi-check-circle-fill', 'Complete');

                            if (prefs.autoPlay) {
                                const autoTimeout = setTimeout(() => playNext(), 2000);
                                timeouts.push(autoTimeout);
                            }
                        }, note.duration * 1000);
                        timeouts.push(finishTimeout);
                    }
                }, time * 1000);

                timeouts.push(t);
                time += note.duration + noteSeparation;
            });
        }

        function stopTone(internal) {
            timeouts.forEach(clearTimeout);
            timeouts = [];
            activeOscillators.forEach(osc => { try { osc.stop(0); } catch {} });
            activeOscillators = [];
            clearInterval(progressInterval);

            if (!internal) {
                isPlaying = false;
                dom.progressBar.style.width = '0%';
                dom.timeElapsed.textContent = '0:00';
                dom.timeTotal.textContent = '0:00';
                setStatus('bi-stop-fill', 'Stopped');
            }
        }

        // ── Tone Loading ──
        async function loadToneFile(filename) {
            try {
                const response = await fetch(`tones/${filename}`);
                if (!response.ok) return null;
                return await response.text();
            } catch {
                return null;
            }
        }

        async function playToneByMeta(tone, indexInFiltered) {
            currentToneMeta = tone;
            currentToneIndex = indexInFiltered;

            // Update now-playing display
            const { artist, title } = parseToneName(tone.name);
            dom.songTitle.classList.remove('show');
            setTimeout(() => {
                dom.songTitle.textContent = title;
                dom.songArtist.textContent = artist;
                dom.songTitle.classList.add('show');
            }, 150);

            document.title = `${title} - ${artist} | Tone Player`;
            setStatus('bi-hourglass-split', 'Loading...');

            let content = tone.content || await loadToneFile(tone.file);
            if (!content) {
                setStatus('bi-exclamation-triangle-fill', 'Failed to load tone');
                return;
            }

            currentTone = content.trim();
            setStatus('bi-play-fill', 'Playing...');
            highlightCurrent();
            await playTone(currentTone);
        }

        function highlightCurrent() {
            dom.toneList.querySelectorAll('.tone-item.playing').forEach(el => el.classList.remove('playing'));
            if (currentToneMeta) {
                const items = dom.toneList.querySelectorAll('.tone-item');
                items.forEach(item => {
                    const idx = parseInt(item.dataset.idx);
                    if (filteredTones[idx] && filteredTones[idx].name === currentToneMeta.name) {
                        item.classList.add('playing');
                    }
                });
            }
        }

        // ── Navigation ──
        function playNext() {
            if (filteredTones.length === 0) return;
            let nextIdx = 0;
            if (currentToneIndex >= 0 && currentToneIndex < filteredTones.length - 1) {
                nextIdx = currentToneIndex + 1;
            }
            playToneByMeta(filteredTones[nextIdx], nextIdx);
            scrollToItem(nextIdx);
        }

        function playPrev() {
            if (filteredTones.length === 0) return;
            let prevIdx = filteredTones.length - 1;
            if (currentToneIndex > 0) {
                prevIdx = currentToneIndex - 1;
            }
            playToneByMeta(filteredTones[prevIdx], prevIdx);
            scrollToItem(prevIdx);
        }

        function playRandom() {
            if (filteredTones.length === 0) return;
            const idx = Math.floor(Math.random() * filteredTones.length);
            playToneByMeta(filteredTones[idx], idx);
            scrollToItem(idx);
        }

        function scrollToItem(idx) {
            const items = dom.toneList.querySelectorAll('.tone-item');
            if (items[idx]) {
                items[idx].scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }

        // ── Favorites ──
        function toggleFavorite(name) {
            const idx = prefs.favorites.indexOf(name);
            if (idx > -1) {
                prefs.favorites.splice(idx, 1);
            } else {
                prefs.favorites.push(name);
            }
            savePrefs();
            // Update just the fav buttons without full re-render
            dom.toneList.querySelectorAll('.tone-item-fav').forEach(btn => {
                if (btn.dataset.name === name) {
                    const isFav = prefs.favorites.includes(name);
                    btn.classList.toggle('is-fav', isFav);
                    btn.querySelector('i').className = `bi bi-heart${isFav ? '-fill' : ''}`;
                }
            });
            // If showing favorites only and we unfavorited, re-filter
            if (prefs.showFavoritesOnly) {
                applyFiltersAndSort();
            }
        }

        // ── Status helper ──
        function setStatus(icon, text) {
            dom.statusText.innerHTML = `<i class="bi ${icon}"></i> ${text}`;
        }

        // ── Load Tones ──
        async function loadTonesList() {
            try {
                const response = await fetch('tones/tones.json');
                if (!response.ok) throw new Error('HTTP ' + response.status);
                tonesList = await response.json();

                if (tonesList.length === 0) throw new Error('Empty library');

                setStatus('bi-hand-index-fill', 'Select a tone or click Random');
                dom.songTitle.textContent = `${tonesList.length.toLocaleString()} tones loaded`;
                dom.songArtist.textContent = 'Ready to play';
                dom.songTitle.classList.add('show');
            } catch {
                tonesList = fallbackTones;
                setStatus('bi-hand-index-fill', 'Using fallback tones');
                dom.songTitle.textContent = `${tonesList.length} fallback tones`;
                dom.songArtist.textContent = 'Could not load full library';
                dom.songTitle.classList.add('show');
            }

            dom.loadingOverlay.style.display = 'none';
            populateArtistFilter();
            applyFiltersAndSort();
        }

        // ── Event Handlers ──
        function initEventHandlers() {
            // Tone list clicks (event delegation)
            dom.toneList.addEventListener('click', (e) => {
                const favBtn = e.target.closest('.tone-item-fav');
                if (favBtn) {
                    e.stopPropagation();
                    toggleFavorite(favBtn.dataset.name);
                    return;
                }

                const item = e.target.closest('.tone-item');
                if (item) {
                    const idx = parseInt(item.dataset.idx);
                    if (filteredTones[idx]) {
                        playToneByMeta(filteredTones[idx], idx);
                    }
                }
            });

            // Transport controls
            dom.btnStop.addEventListener('click', () => stopTone(false));
            dom.btnPrev.addEventListener('click', playPrev);
            dom.btnNext.addEventListener('click', playNext);
            dom.btnRandom.addEventListener('click', playRandom);

            // Auto-play toggle
            dom.btnAutoPlay.addEventListener('click', () => {
                prefs.autoPlay = !prefs.autoPlay;
                dom.btnAutoPlay.classList.toggle('active', prefs.autoPlay);
                savePrefs();
            });

            // Volume
            dom.volumeSlider.addEventListener('input', () => {
                prefs.volume = dom.volumeSlider.value / 100;
                savePrefs();
            });

            // Speed
            dom.speedSelect.addEventListener('change', () => {
                prefs.speed = parseFloat(dom.speedSelect.value);
                savePrefs();
            });

            // Waveform
            dom.waveSelect.addEventListener('change', () => {
                prefs.waveform = dom.waveSelect.value;
                savePrefs();
            });

            // Search
            let searchTimeout;
            dom.searchInput.addEventListener('input', () => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(applyFiltersAndSort, 200);
            });

            // Sort
            dom.sortSelect.addEventListener('change', () => {
                prefs.sortBy = dom.sortSelect.value;
                savePrefs();
                applyFiltersAndSort();
            });

            // Artist filter
            dom.artistFilter.addEventListener('change', applyFiltersAndSort);

            // Favorites filter
            dom.btnFavFilter.addEventListener('click', () => {
                prefs.showFavoritesOnly = !prefs.showFavoritesOnly;
                dom.btnFavFilter.classList.toggle('active', prefs.showFavoritesOnly);
                savePrefs();
                applyFiltersAndSort();
            });

            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                // Don't trigger if typing in search
                if (e.target === dom.searchInput) {
                    if (e.key === 'Escape') {
                        dom.searchInput.blur();
                        dom.searchInput.value = '';
                        applyFiltersAndSort();
                    }
                    return;
                }

                switch (e.key.toLowerCase()) {
                    case ' ':
                        e.preventDefault();
                        stopTone(false);
                        break;
                    case 'r':
                        playRandom();
                        break;
                    case 'n':
                        playNext();
                        break;
                    case 'p':
                        playPrev();
                        break;
                    case '/':
                        e.preventDefault();
                        dom.searchInput.focus();
                        break;
                }
            });
        }

        // ── Init ──
        window.addEventListener('DOMContentLoaded', () => {
            loadPrefs();
            initEventHandlers();
            loadTonesList();
        });
    </script>
</body>
</html>
