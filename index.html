<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Play Tone</title>
    <style>
        body {
            margin: 0;
            background: #1a1a1a;
            color: white;
            font-family: monospace;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            text-align: center;
        }
        .player {
            padding: 20px;
            border: 2px solid #4a9eff;
            border-radius: 10px;
            background: rgba(74, 158, 255, 0.1);
        }
        .status {
            font-size: 24px;
            margin-bottom: 10px;
        }
        .progress {
            width: 300px;
            height: 4px;
            background: #333;
            border-radius: 2px;
            overflow: hidden;
            margin: 20px auto;
        }
        .bar {
            height: 100%;
            background: #4a9eff;
            width: 0%;
            transition: width 0.1s;
        }
    </style>
</head>
<body>
    <div class="player">
        <div class="status" id="status">Playing Tone...</div>
        <div class="progress"><div class="bar" id="bar"></div></div>
        <div>Tone Player</div>
    </div>

    <script>
        const tone = "Toneb:d=4,o=5,b=90:8a,8b,16g6,16g6,8g6,8a6,8g6,8f#6,8f#6,16b,16b,8f#6,16f#6,16f#6,16g6,16f#6,e6,16b,16b,16b,16b,16b,16b,8e6,16b,16b,8b,16b,16g,8a,8b,16b,16b,16a,16g,8a,8b,16g,16f#,e,16b,16b,16b,16b,8b,8b,8g6,8g6,16g6,16a6,8g6,8f#6,8f#.6,16b,8f#6,16f#6,16f#6,16g6,16f#6,e6,16b,16b,16b,16b,16b,16b,8e6,8b,16b,16g,8a,8b,16b,16g,8a,8b,8a,16b,16f#,16g,16f#,2e";
        
        let audioContext;
        let timeouts = [];

        const freq = {
            'c': 261.63, 'c#': 279.07, 'd': 293.66, 'd#': 311.13, 'e': 329.63,
            'f': 349.23, 'f#': 369.99, 'g': 392.00, 'g#': 415.30, 'a': 440.00,
            'a#': 466.16, 'b': 493.88
        };

        function getFreq(note, octave) {
            const base = freq[note.toLowerCase()];
            return base ? base * Math.pow(2, octave - 5) : 0;
        }

        function playNote(frequency, duration) {
            if (!frequency) return;
            const osc = audioContext.createOscillator();
            const gain = audioContext.createGain();
            osc.connect(gain);
            gain.connect(audioContext.destination);
            osc.frequency.value = frequency;
            osc.type = 'square';
            gain.gain.setValueAtTime(0.1, audioContext.currentTime);
            gain.gain.linearRampToValueAtTime(0, audioContext.currentTime + duration);
            osc.start();
            osc.stop(audioContext.currentTime + duration);
        }

        function parseRTTTL(rtttl) {
            const parts = rtttl.split(':');
            const [name, defaults, notes] = parts;
            
            let bpm = 120, defDur = 4, defOct = 5;
            defaults.split(',').forEach(p => {
                const [k, v] = p.split('=');
                if (k === 'b') bpm = parseInt(v);
                if (k === 'd') defDur = parseInt(v);
                if (k === 'o') defOct = parseInt(v);
            });

            const result = [];
            notes.split(',').forEach(token => {
                token = token.trim();
                if (!token) return;

                let dur = defDur, oct = defOct, note = '';
                
                const durMatch = token.match(/^(\d+)/);
                if (durMatch) {
                    dur = parseInt(durMatch[1]);
                    token = token.slice(durMatch[1].length);
                }
                
                const noteMatch = token.match(/^([a-gp]#?)/i);
                if (noteMatch) {
                    note = noteMatch[1].toLowerCase();
                    token = token.slice(noteMatch[1].length);
                }
                
                const octMatch = token.match(/^(\d)/);
                if (octMatch) {
                    oct = parseInt(octMatch[1]);
                }
                
                const dots = (token.match(/\./g) || []).length;
                let duration = (60 / bpm) * (4 / dur);
                for (let i = 0; i < dots; i++) duration *= 1.5;

                const frequency = note === 'p' ? 0 : getFreq(note, oct);
                result.push({ frequency, duration });
            });

            return result;
        }

        async function playTone() {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            await audioContext.resume();
            
            const notes = parseRTTTL(tone);
            const total = notes.reduce((s, n) => s + n.duration, 0);
            
            let time = 0;
            notes.forEach((note, i) => {
                const timeout = setTimeout(() => {
                    playNote(note.frequency, note.duration);
                    const progress = ((time + note.duration) / total) * 100;
                    document.getElementById('bar').style.width = progress + '%';
                    
                    if (i === notes.length - 1) {
                        setTimeout(() => {
                            document.getElementById('status').textContent = 'Complete';
                        }, note.duration * 1000);
                    }
                }, time * 1000);
                
                timeouts.push(timeout);
                time += note.duration;
            });
        }

        window.addEventListener('load', () => {
            setTimeout(playTone, 500);
        });

        document.addEventListener('click', () => {
            timeouts.forEach(clearTimeout);
            timeouts = [];
            document.getElementById('bar').style.width = '0%';
            document.getElementById('status').textContent = 'Playing Tone...';
            setTimeout(playTone, 100);
        });
    </script>
</body>
</html>
</script>
