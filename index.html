<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Random Tone Player</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body {
            margin: 0;
            background: #1a1a1a;
            color: white;
            font-family: monospace;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            text-align: center;
        }
        .player {
            padding: 30px;
            border: 2px solid #4a9eff;
            border-radius: 15px;
            background: rgba(74, 158, 255, 0.1);
            min-width: 420px;
        }
        .song-title {
            font-size: 22px;
            font-weight: bold;
            margin-bottom: 5px;
            color: #4a9eff;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            opacity: 0;
            transition: opacity 0.5s;
        }
        .song-title.show {
            opacity: 1;
        }
        .song-file {
            font-size: 13px;
            color: #bbb;
            margin-bottom: 15px;
        }
        .status {
            font-size: 18px;
            margin-bottom: 15px;
            color: #eee;
        }
        .progress {
            width: 320px;
            height: 6px;
            background: #333;
            border-radius: 3px;
            overflow: hidden;
            margin: 20px auto;
        }
        .bar {
            height: 100%;
            background: #4a9eff;
            width: 0%;
            transition: width 0.15s;
        }
        .icon {
            margin-right: 6px;
        }
        .controls {
            margin-top: 20px;
        }
        .btn {
            background: #4a9eff;
            border: none;
            color: white;
            padding: 8px 16px;
            margin: 0 6px;
            border-radius: 5px;
            cursor: pointer;
            font-family: monospace;
        }
        .btn:hover {
            background: #3a8eef;
        }
        .loading {
            color: #888;
        }
    </style>
</head>
<body>
    <div class="player">
        <div class="song-title" id="songTitle"><i class="bi bi-music-note-beamed"></i>Loading tones...</div>
        <div class="song-file" id="songFile">Please wait</div>
        <div class="status" id="status"><i class="bi bi-hourglass-split icon"></i>Loading...</div>
        <div class="progress"><div class="bar" id="bar"></div></div>
        <div class="controls">
            <button class="btn" onclick="playRandomTone()">
                <i class="bi bi-shuffle"></i>Random Tone
            </button>
            <button class="btn" onclick="stopTone()">
                <i class="bi bi-stop-fill"></i>Stop
            </button>
        </div>
        <div style="margin-top: 15px; font-size: 12px; color: #666;">
            Tone Player - Click anywhere to play
        </div>
    </div>

    <script>
        let audioContext;
        let timeouts = [];
        let tonesList = [];
        let currentTone = '';
        let hasPlayed = false;

        const freq = {
            'c': 261.63, 'c#': 279.07, 'db': 279.07,
            'd': 293.66, 'd#': 311.13, 'eb': 311.13,
            'e': 329.63,
            'f': 349.23, 'f#': 369.99, 'gb': 369.99,
            'g': 392.00, 'g#': 415.30, 'ab': 415.30,
            'a': 440.00, 'a#': 466.16, 'bb': 466.16,
            'b': 493.88
        };

        async function loadTonesList() {
            try {
                const response = await fetch('tones/tones.json');
                tonesList = await response.json();
                
                if (tonesList.length > 0) {
                    document.getElementById('status').innerHTML = '<i class="bi bi-hand-index-fill icon"></i>Click to play random tone';
                    document.getElementById('songTitle').textContent = `${tonesList.length} tones loaded`;
                    document.getElementById('songFile').textContent = 'Ready';
                    document.getElementById('songTitle').classList.add('show');
                    try { await playRandomTone(); } catch {}
                } else {
                    throw new Error('No tones found');
                }
            } catch {
                tonesList = [{
                    name: "Mockingbird",
                    file: "mockingbird.txt",
                    content: "Mockingb:d=4,o=5,b=90:8a,8b,16g6,16g6,8g6,8a6,8g6,8f#6,8f#6,16b,16b,8f#6,16f#6,16f#6,16g6,16f#6,e6,16b,16b,16b,16b,16b,16b,8e6,16b,16b,8b,16b,16g,8a,8b,16b,16b,16a,16g,8a,8b,16g,16f#,e,16b,16b,16b,16b,8b,8b,8g6,8g6,16g6,16a6,8g6,8f#6,8f#.6,16b,8f#6,16f#6,16f#6,16g6,16f#6,e6,16b,16b,16b,16b,16b,16b,8e6,8b,16b,16g,8a,8b,16b,16g,8a,8b,8a,16b,16f#,16g,16f#,2e"
                }];
                document.getElementById('status').innerHTML = '<i class="bi bi-hand-index-fill icon"></i>Click to play';
                document.getElementById('songTitle').textContent = 'Fallback Tone';
                document.getElementById('songFile').textContent = 'mockingbird';
                document.getElementById('songTitle').classList.add('show');
                try { await playRandomTone(); } catch {}
            }
        }

        async function loadToneFile(filename) {
            try {
                const response = await fetch(`tones/${filename}`);
                return await response.text();
            } catch {
                return null;
            }
        }

        async function playRandomTone() {
            if (tonesList.length === 0) return;
            const randomTone = tonesList[Math.floor(Math.random() * tonesList.length)];
            
            let toneContent = randomTone.content ? randomTone.content : await loadToneFile(randomTone.file);
            if (!toneContent) return;
            currentTone = toneContent.trim();

            const songTitle = document.getElementById('songTitle');
            const songFile = document.getElementById('songFile');
            songTitle.classList.remove('show');
            setTimeout(() => {
                songTitle.innerHTML = `<i class="bi bi-music-note-beamed"></i> ${randomTone.name}`;
                let displayFile = randomTone.file ? randomTone.file.replace(/\.txt$/i, '') : "inline tone";
                songFile.textContent = displayFile;
                songTitle.classList.add('show');
            }, 200);

            document.getElementById('status').innerHTML = '<i class="bi bi-play-fill icon"></i>Playing...';
            await playTone(currentTone);
            hasPlayed = true;
        }

        function stopTone() {
            timeouts.forEach(clearTimeout);
            timeouts = [];
            document.getElementById('bar').style.width = '0%';
            document.getElementById('status').innerHTML = '<i class="bi bi-stop-fill icon"></i>Stopped';
        }

        function getFreq(note, octave) {
            if (!note) return 0;
            
            note = note.toLowerCase();
            
            const base = freq[note];
            if (!base) return 0;
            
            octave = Math.max(0, Math.min(10, octave));
            
            return base * Math.pow(2, octave - 5);
        }

        function playNote(frequency, duration) {
            if (!frequency || !audioContext) return;
            
            try {
                const osc = audioContext.createOscillator();
                const gain = audioContext.createGain();
                osc.connect(gain);
                gain.connect(audioContext.destination);
                
                osc.frequency.value = Math.max(20, Math.min(20000, frequency));
                osc.type = 'square';
                
                const now = audioContext.currentTime;
                gain.gain.setValueAtTime(0, now);
                gain.gain.linearRampToValueAtTime(0.1, now + 0.01);
                gain.gain.linearRampToValueAtTime(0.1, now + duration - 0.01);
                gain.gain.linearRampToValueAtTime(0, now + duration);
                
                osc.start(now);
                osc.stop(now + duration);
            } catch (error) {
                console.warn('Error playing note:', error);
            }
        }

        function parseRTTTL(rtttl) {
            try {
                const parts = rtttl.split(':');
                if (parts.length < 3) {
                    throw new Error('Invalid RTTTL format');
                }
                
                const [name, defaults, notes] = parts;
                let bpm = 120, defDur = 4, defOct = 5;
                
                defaults.split(',').forEach(p => {
                    const trimmed = p.trim();
                    if (trimmed.includes('=')) {
                        const [k, v] = trimmed.split('=');
                        const key = k.trim().toLowerCase();
                        const value = parseInt(v.trim());
                        if (!isNaN(value)) {
                            if (key === 'b') bpm = Math.max(1, value);
                            if (key === 'd') defDur = Math.max(1, value);
                            if (key === 'o') defOct = Math.max(0, Math.min(10, value));
                        }
                    }
                });

                const result = [];
                const noteTokens = notes.split(',');
                
                noteTokens.forEach(token => {
                    token = token.trim();
                    if (!token) return;
                    
                    let dur = defDur, oct = defOct, note = '';
                    let remainingToken = token;
                    
                    const durMatch = remainingToken.match(/^(\d+)/);
                    if (durMatch) {
                        dur = parseInt(durMatch[1]);
                        remainingToken = remainingToken.slice(durMatch[1].length);
                    }
                    
                    const noteMatch = remainingToken.match(/^([a-gpr]#?b?)/i);
                    if (noteMatch) {
                        note = noteMatch[1].toLowerCase();
                        remainingToken = remainingToken.slice(noteMatch[1].length);
                        
                        if (note === 'r') note = 'p';
                    }
                    
                    const octMatch = remainingToken.match(/^(\d+)/);
                    if (octMatch) {
                        oct = parseInt(octMatch[1]);
                        remainingToken = remainingToken.slice(octMatch[1].length);
                    }
                    
                    const dots = (remainingToken.match(/\./g) || []).length;
                    
                    let duration = (60 / bpm) * (4 / dur);
                    for (let i = 0; i < dots; i++) {
                        duration *= 1.5;
                    }
                    
                    const frequency = (note === 'p' || note === 'r') ? 0 : getFreq(note, oct);
                    
                    result.push({ frequency, duration, note, octave: oct });
                });
                
                return result;
            } catch (error) {
                console.error('Error parsing RTTTL:', error);
                return [];
            }
        }

        async function playTone(toneString) {
            if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
            await audioContext.resume();
            stopTone();
            
            const notes = parseRTTTL(toneString);
            if (notes.length === 0) {
                document.getElementById('status').innerHTML = '<i class="bi bi-exclamation-triangle-fill icon"></i>Invalid tone format';
                return;
            }
            
            const total = notes.reduce((s, n) => s + n.duration, 0);
            let time = 0;
            
            notes.forEach((note, i) => {
                const timeout = setTimeout(() => {
                    if (note.frequency > 0) {
                        playNote(note.frequency, note.duration);
                    }
                    const progress = ((time + note.duration) / total) * 100;
                    document.getElementById('bar').style.width = progress + '%';
                    
                    if (i === notes.length - 1) {
                        setTimeout(() => {
                            document.getElementById('status').innerHTML = '<i class="bi bi-check-circle-fill icon"></i>Complete';
                            setTimeout(playRandomTone, 2000);
                        }, note.duration * 1000);
                    }
                }, time * 1000);
                
                timeouts.push(timeout);
                time += note.duration;
            });
        }

        window.addEventListener('load', loadTonesList);
        document.addEventListener('click', (e) => {
            if (!e.target.matches('button')) playRandomTone();
        });
    </script>
</body>
</html>